<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Agentforce Exam</title>
<style>
  * { box-sizing: border-box; }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    max-width: 900px;
    margin: 0 auto;
    padding: 12px;
    font-size: 16px;
    line-height: 1.5;
    background: #fff;
  }

  h2 { font-size: 1.4rem; margin: 0 0 10px 0; }

  button {
    padding: 12px 16px;
    font-size: 16px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f5f5f5;
    cursor: pointer;
    touch-action: manipulation;
    margin: 4px;
  }

  button:active { background: #e0e0e0; }
  button:disabled { opacity: 0.5; }
  .hidden { display: none; }

  #loadStatus { font-size: 14px; color: #666; margin-bottom: 8px; }

  #timer {
    color: #555;
    font-size: 15px;
    font-weight: 600;
    padding: 8px 12px;
    background: #f0f0f0;
    border-radius: 6px;
    display: inline-block;
    margin-bottom: 10px;
  }

  #helpToggle { color: #666; font-size: 14px; cursor: pointer; padding: 8px 0; display: inline-block; }

  #helpBox, #modeSelector {
    border: 1px solid #e0e0e0;
    padding: 12px;
    font-size: 14px;
    color: #555;
    margin-bottom: 12px;
    background: #fafafa;
    border-radius: 8px;
  }

  #modeSelector h4 { margin: 0 0 10px 0; font-size: 15px; color: #333; }
  .mode-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px; }
  .mode-buttons button { flex: 1; min-width: 140px; }
  .mode-buttons button.active { background: #007bff; color: #fff; border-color: #007bff; }
  
  #examButtons { display: flex; flex-wrap: wrap; gap: 8px; }
  #examButtons button { flex: 1; min-width: calc(50% - 8px); }

  #helpBox > div { display: flex; flex-direction: column; gap: 6px; }

  .question-header { display: flex; flex-direction: column; gap: 10px; margin-bottom: 12px; }
  #counter { font-weight: 600; font-size: 15px; color: #333; margin: 0; }
  #modeIndicator { font-size: 13px; padding: 4px 8px; border-radius: 4px; display: inline-block; }
  #modeIndicator.learning { background: #d4edda; color: #155724; }
  #modeIndicator.exam { background: #fff3cd; color: #856404; }

  .confidence-panel {
    border: 1px solid #e0e0e0;
    background: #fafafa;
    padding: 12px;
    font-size: 15px;
    border-radius: 8px;
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }

  .confidence-panel label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
  .confidence-panel input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }

  .question-box {
    border: 1px solid #e0e0e0;
    background: #f7f7f7;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 12px;
  }

  .question-box p { margin: 0; font-size: 16px; line-height: 1.6; }

  .answers-box {
    border: 1px solid #e0e0e0;
    background: #fafafa;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 12px;
  }

  .answer {
    padding: 14px 12px;
    margin-bottom: 8px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    transition: background 0.15s;
  }

  .answer:last-child { margin-bottom: 0; }
  .answer:active { background: #f0f0f0; }
  .answer span { color: #888; font-size: 13px; font-weight: 600; min-width: 24px; }

  .answer label {
    flex: 1;
    font-size: 15px;
    line-height: 1.5;
    cursor: pointer;
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }

  .answer input[type="radio"] { width: 22px; height: 22px; min-width: 22px; cursor: pointer; margin: 0; }

  .answer.correct { background: #d4edda; border-color: #28a745; }
  .answer.correct label { color: #155724; font-weight: 600; }
  .answer.wrong { background: #f8d7da; border-color: #dc3545; }
  .answer.wrong label { color: #721c24; font-weight: 600; }

  #resultLine {
    margin-top: 12px;
    padding: 12px;
    font-weight: 600;
    font-size: 15px;
    border-radius: 6px;
    text-align: center;
  }

  #resultLine:empty { display: none; }

  .nav-buttons { display: flex; gap: 10px; margin-top: 12px; }
  .nav-buttons button { flex: 1; padding: 14px; font-size: 16px; font-weight: 600; }
  #nextBtn { background: #007bff; color: #fff; border-color: #007bff; }
  #nextBtn:active { background: #0056b3; }

  #stats { padding: 16px; background: #f9f9f9; border-radius: 10px; }
  #stats h3 { margin: 0 0 12px 0; font-size: 1.2rem; }
  #stats p { margin: 8px 0; font-size: 15px; line-height: 1.5; word-break: break-word; }

  #reviewButtons { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }
  #reviewButtons button { width: 100%; text-align: left; padding: 14px 16px; }

  hr { border: none; border-top: 1px solid #e0e0e0; margin: 12px 0; }

  @media (min-width: 600px) {
    body { padding: 20px; }
    .question-header { flex-direction: row; justify-content: space-between; align-items: center; }
    #examButtons button { min-width: auto; flex: none; }
    #reviewButtons { flex-direction: row; flex-wrap: wrap; }
    #reviewButtons button { width: auto; flex: 1; }
  }
</style>
</head>
<body>

<h2>Agentforce Exam</h2>
<div id="loadStatus">‚è≥ –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –≤—ä–ø—Ä–æ—Å–∏—Ç–µ...</div>
<div id="timer" class="hidden">Time: 105:00</div>

<div id="helpToggle">üõà –ü–æ–º–æ—â / –ö–ª–∞–≤–∏—à–∏</div>
<div id="helpBox" class="hidden">
  <div>
    <div>üî¢ <b>1‚Äì4</b> ‚Äì –∏–∑–±–æ—Ä –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä</div>
    <div>‚û°Ô∏è <b>‚Üí / Enter</b> ‚Äì Next</div>
    <div>‚¨ÖÔ∏è <b>‚Üê</b> ‚Äì Back</div>
  </div>
</div>

<button id="shuffleBtn" disabled>üîÄ –†–∞–∑–±—ä—Ä–∫–∞–π –≤—ä–ø—Ä–æ—Å–∏—Ç–µ</button>

<div id="modeSelector" class="hidden">
  <h4>–ò–∑–±–µ—Ä–∏ —Ä–µ–∂–∏–º:</h4>
  <div class="mode-buttons">
    <button id="learningModeBtn" class="active">üìö Learning Mode</button>
    <button id="examModeBtn">üìù Exam Mode</button>
  </div>
  <p id="modeDescription">–í–∏–∂–¥–∞—à –≤–µ—Ä–Ω–∏—è –æ—Ç–≥–æ–≤–æ—Ä –≤–µ–¥–Ω–∞–≥–∞ —Å–ª–µ–¥ –≤—Å–µ–∫–∏ –≤—ä–ø—Ä–æ—Å.</p>
  <div id="examButtons"></div>
</div>

<hr>

<div id="exam" class="hidden">
  <div class="question-header">
    <div>
      <p id="counter"></p>
      <span id="modeIndicator"></span>
    </div>
    <div class="confidence-panel">
      <label><input type="checkbox" id="dontKnow"> ‚ùì –ù–µ –∑–Ω–∞–º</label>
      <label><input type="checkbox" id="notSure"> ‚ö†Ô∏è –ù–µ —Å—ä–º —Å–∏–≥—É—Ä–µ–Ω</label>
    </div>
  </div>

  <div class="question-box"><p id="question"></p></div>

  <div class="answers-box">
    <div id="answers"></div>
    <div id="resultLine"></div>
  </div>

  <div class="nav-buttons">
    <button id="backBtn">‚Üê Back</button>
    <button id="nextBtn">Next ‚Üí</button>
  </div>
</div>

<div id="stats" class="hidden"></div>

<script>
const $ = id => document.getElementById(id);
const modeSelectorEl = $("modeSelector");
const examButtonsEl = $("examButtons");
const examEl = $("exam");
const timerEl = $("timer");
const statsEl = $("stats");
const helpBoxEl = $("helpBox");
const helpToggleEl = $("helpToggle");
const counterEl = $("counter");
const modeIndicatorEl = $("modeIndicator");
const questionEl = $("question");
const answersEl = $("answers");
const dontKnowEl = $("dontKnow");
const notSureEl = $("notSure");
const resultLineEl = $("resultLine");
const shuffleBtn = $("shuffleBtn");
const backBtn = $("backBtn");
const nextBtn = $("nextBtn");
const loadStatusEl = $("loadStatus");
const learningModeBtn = $("learningModeBtn");
const examModeBtn = $("examModeBtn");
const modeDescriptionEl = $("modeDescription");

let QUESTIONS = {}, ALL_QIDS = [], EXAMS = [], STACK = [], index = 0;
let questionState = {}, answerOrder = {};
let baseStack = null, baseState = null;
let examStartTime = null, timerInterval = null;
const EXAM_TIME_SECONDS = 105 * 60;
let currentRoundType = "base";
let currentMode = "learning"; // "learning" or "exam"

// Load questions
fetch("./agentforce_questions.json")
  .then(r => { if (!r.ok) throw new Error("JSON load failed"); return r.json(); })
  .then(d => {
    d.questions.forEach(q => { QUESTIONS[q.number] = q; ALL_QIDS.push(q.number); });
    shuffleBtn.disabled = false;
    loadStatusEl.textContent = `‚úì –ó–∞—Ä–µ–¥–µ–Ω–∏ ${ALL_QIDS.length} –≤—ä–ø—Ä–æ—Å–∞`;
    loadStatusEl.style.color = "#28a745";
  })
  .catch(err => {
    loadStatusEl.textContent = "‚úó –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ";
    loadStatusEl.style.color = "#dc3545";
    console.error(err);
  });

function shuffle(arr) { return arr.map(v => ({ v, r: Math.random() })).sort((a, b) => a.r - b.r).map(x => x.v); }
function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }
function getCorrectText(qid) { return QUESTIONS[qid].correct.map(a => QUESTIONS[qid].answers[a]).join(", "); }
function ensureOrderForQid(qid) { if (!answerOrder[qid]) answerOrder[qid] = shuffle(Object.entries(QUESTIONS[qid].answers)); }

// Mode selection
learningModeBtn.addEventListener("click", () => {
  currentMode = "learning";
  learningModeBtn.classList.add("active");
  examModeBtn.classList.remove("active");
  modeDescriptionEl.textContent = "–í–∏–∂–¥–∞—à –≤–µ—Ä–Ω–∏—è –æ—Ç–≥–æ–≤–æ—Ä –≤–µ–¥–Ω–∞–≥–∞ —Å–ª–µ–¥ –≤—Å–µ–∫–∏ –≤—ä–ø—Ä–æ—Å.";
});

examModeBtn.addEventListener("click", () => {
  currentMode = "exam";
  examModeBtn.classList.add("active");
  learningModeBtn.classList.remove("active");
  modeDescriptionEl.textContent = "–°–∏–º—É–ª–∞—Ü–∏—è –Ω–∞ –∏–∑–ø–∏—Ç - —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —Å–µ –ø–æ–∫–∞–∑–≤–∞—Ç –Ω–∞–∫—Ä–∞—è.";
});

// Shuffle button
shuffleBtn.addEventListener("click", () => {
  if (EXAMS.length > 0) {
    modeSelectorEl.classList.toggle("hidden");
    return;
  }
  
  const s = shuffle([...ALL_QIDS]);
  EXAMS = [];
  const size = Math.ceil(s.length / 5);
  for (let i = 0; i < 5; i++) EXAMS.push(s.slice(i * size, (i + 1) * size));
  
  examButtonsEl.innerHTML = EXAMS.map((e, i) => `<button data-exam="${i}">–ò–∑–ø–∏—Ç ${i + 1} (${e.length})</button>`).join("");
  modeSelectorEl.classList.remove("hidden");
});

examButtonsEl.addEventListener("click", e => {
  const btn = e.target.closest("button");
  if (btn) startRound("base", EXAMS[Number(btn.dataset.exam)]);
});

// Timer
function startTimer() {
  clearInterval(timerInterval);
  examStartTime = Date.now();
  timerEl.innerText = "Time: 105:00";
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - examStartTime) / 1000);
    const remaining = Math.max(EXAM_TIME_SECONDS - elapsed, 0);
    timerEl.innerText = `Time: ${String(Math.floor(remaining / 60)).padStart(2, "0")}:${String(remaining % 60).padStart(2, "0")}`;
    if (remaining === 0) finishExam();
  }, 1000);
}

function startRound(roundType, stack) {
  if (!stack || !stack.length) return;
  currentRoundType = roundType;
  STACK = stack.slice();
  index = 0;
  questionState = {};
  answerOrder = {};
  modeSelectorEl.classList.add("hidden");
  helpBoxEl.classList.add("hidden");
  statsEl.classList.add("hidden");
  examEl.classList.remove("hidden");
  timerEl.classList.remove("hidden");
  
  modeIndicatorEl.textContent = currentMode === "learning" ? "üìö Learning" : "üìù Exam";
  modeIndicatorEl.className = currentMode;
  
  startTimer();
  showQuestion();
}

function showQuestion() {
  const qid = STACK[index], q = QUESTIONS[qid];
  ensureOrderForQid(qid);
  const state = questionState[qid];

  counterEl.innerText = `[Q${qid}] ${index + 1} / ${STACK.length}`;
  questionEl.innerText = q.question;
  answersEl.innerHTML = "";
  resultLineEl.innerHTML = "";
  resultLineEl.style.background = "";
  resultLineEl.style.color = "";

  dontKnowEl.checked = state?.dontKnow || false;
  notSureEl.checked = state?.notSure || false;

  answerOrder[qid].forEach(([l, t], i) => {
    answersEl.innerHTML += `<div class="answer" data-letter="${l}"><span>(${i + 1})</span><label><input type="radio" name="answer" value="${l}">${t}</label></div>`;
  });

  if (state?.selectedAnswer) {
    const r = document.querySelector(`input[name="answer"][value="${state.selectedAnswer}"]`);
    if (r) r.checked = true;
  }

  // Learning mode: show feedback if already answered
  if (currentMode === "learning" && state && state.status && state.status !== "unanswered") {
    document.querySelectorAll('input[name="answer"]').forEach(r => r.disabled = true);
    dontKnowEl.disabled = true;
    notSureEl.disabled = true;
    const selWrap = document.querySelector(`input[name="answer"][value="${state.selectedAnswer}"]`)?.closest(".answer");
    if (state.status === "correct") {
      selWrap?.classList.add("correct");
      resultLineEl.innerText = "‚úÖ –í—è—Ä–Ω–æ";
      resultLineEl.style.background = "#d4edda";
      resultLineEl.style.color = "#155724";
    } else {
      selWrap?.classList.add("wrong");
      resultLineEl.innerText = `‚ùå –ì—Ä–µ—à–Ω–æ ‚Üí ${getCorrectText(qid)}`;
      resultLineEl.style.background = "#f8d7da";
      resultLineEl.style.color = "#721c24";
    }
  } else {
    document.querySelectorAll('input[name="answer"]').forEach(r => r.disabled = false);
    dontKnowEl.disabled = false;
    notSureEl.disabled = false;
  }
}

function upsertDraftState() {
  const qid = STACK[index], existing = questionState[qid];
  if (currentMode === "learning" && existing && existing.status && existing.status !== "unanswered") return;
  const sel = document.querySelector('input[name="answer"]:checked');
  questionState[qid] = {
    selectedAnswer: sel ? sel.value : (existing?.selectedAnswer || null),
    status: existing?.status || "unanswered",
    dontKnow: dontKnowEl.checked,
    notSure: notSureEl.checked
  };
}

answersEl.addEventListener("change", e => { if (e.target?.name === "answer") upsertDraftState(); });
answersEl.addEventListener("click", e => {
  const answerDiv = e.target.closest(".answer");
  if (answerDiv) {
    const radio = answerDiv.querySelector('input[type="radio"]');
    if (radio && !radio.disabled) { radio.checked = true; upsertDraftState(); }
  }
});
dontKnowEl.addEventListener("change", upsertDraftState);
notSureEl.addEventListener("change", upsertDraftState);

function checkCurrentQuestion() {
  const qid = STACK[index], q = QUESTIONS[qid];
  const sel = document.querySelector('input[name="answer"]:checked');
  if (!sel) return false;
  questionState[qid] = {
    selectedAnswer: sel.value,
    status: q.correct.includes(sel.value) ? "correct" : "wrong",
    dontKnow: dontKnowEl.checked,
    notSure: notSureEl.checked
  };
  return true;
}

function nextAction() {
  const qid = STACK[index];
  const state = questionState[qid];
  const sel = document.querySelector('input[name="answer"]:checked');
  
  if (!sel) return;

  if (currentMode === "learning") {
    // Learning: first click checks, second click advances
    if (!state || state.status === "unanswered") {
      checkCurrentQuestion();
      showQuestion();
      return;
    }
    if (index < STACK.length - 1) { index++; showQuestion(); }
    else finishExam();
  } else {
    // Exam: just save and advance
    checkCurrentQuestion();
    if (index < STACK.length - 1) { index++; showQuestion(); }
    else finishExam();
  }
}

function goBack() { if (index > 0) { index--; showQuestion(); } }

nextBtn.addEventListener("click", nextAction);
backBtn.addEventListener("click", goBack);

document.addEventListener("keydown", e => {
  if (examEl.classList.contains("hidden")) return;
  if (["1", "2", "3", "4"].includes(e.key)) {
    const radios = document.querySelectorAll('input[name="answer"]');
    if (radios[e.key - 1] && !radios[e.key - 1].disabled) { radios[e.key - 1].checked = true; upsertDraftState(); }
  }
  if (e.key === "ArrowRight" || e.key === "Enter") nextAction();
  if (e.key === "ArrowLeft") goBack();
});

helpToggleEl.addEventListener("click", () => helpBoxEl.classList.toggle("hidden"));

function computeStats(stateObj, stackArr) {
  let correct = 0, wrong = [], dk = [], ns = [], correctButNotSure = [];
  stackArr.forEach(qid => {
    const s = stateObj[qid];
    if (!s || !s.status || s.status === "unanswered") return;
    if (s.dontKnow) dk.push(qid);
    if (s.notSure) ns.push(qid);
    if (s.status === "correct") { correct++; if (s.notSure) correctButNotSure.push(qid); }
    else wrong.push(qid);
  });
  return { correct, wrong, dk, ns, correctButNotSure };
}

function finishExam() {
  clearInterval(timerInterval);
  examEl.classList.add("hidden");
  timerEl.classList.add("hidden");
  if (currentRoundType === "base") { baseState = deepClone(questionState); baseStack = STACK.slice(); }
  renderStatsScreen();
}

function renderStatsScreen() {
  statsEl.classList.remove("hidden");
  const t = STACK.length, sec = examStartTime ? Math.floor((Date.now() - examStartTime) / 1000) : 0;
  const { correct, wrong, dk, ns, correctButNotSure } = computeStats(questionState, STACK);
  const pct = t ? Math.round(correct / t * 100) : 0;
  const passed = pct >= 72;
  
  const modeLabel = currentMode === "learning" ? "üìö Learning Mode" : "üìù Exam Mode";
  const titles = { base: "–†–µ–∑—É–ª—Ç–∞—Ç", reviewWrong: "–ü—Ä–µ–≥–ª–µ–¥: –≥—Ä–µ—à–Ω–∏", reviewNotSure: "–ü—Ä–µ–≥–ª–µ–¥: –Ω–µ—Å–∏–≥—É—Ä–Ω–∏", reviewDontKnow: "–ü—Ä–µ–≥–ª–µ–¥: –Ω–µ –∑–Ω–∞–º" };

  let reviewHtml = "";
  if (baseState && baseStack && currentMode === "learning") {
    const bs = computeStats(baseState, baseStack);
    reviewHtml = `<div id="reviewButtons">
      <button id="reviewWrongBtn" ${bs.wrong.length ? "" : "disabled"}>üîÅ –ì—Ä–µ—à–Ω–∏ (${bs.wrong.length})</button>
      <button id="reviewNotSureBtn" ${bs.ns.length ? "" : "disabled"}>‚ö†Ô∏è –ù–µ—Å–∏–≥—É—Ä–Ω–∏ (${bs.ns.length})</button>
      <button id="reviewDontKnowBtn" ${bs.dk.length ? "" : "disabled"}>‚ùì –ù–µ –∑–Ω–∞–º (${bs.dk.length})</button>
      ${currentRoundType !== "base" ? `<button id="backToBaseResultsBtn">‚¨ÖÔ∏è –û—Å–Ω–æ–≤–µ–Ω —Ä–µ–∑—É–ª—Ç–∞—Ç</button>` : ""}
    </div>`;
  }

  statsEl.innerHTML = `
    <h3>${titles[currentRoundType] || "–†–µ–∑—É–ª—Ç–∞—Ç"} <small style="font-weight:normal;color:#666;">(${modeLabel})</small></h3>
    <p style="font-size:18px;"><strong>${passed ? "‚úÖ –í–ó–ï–¢" : "‚ùå –ù–ï –ï –í–ó–ï–¢"}</strong> (–º–∏–Ω. 72%)</p>
    <p><strong>–í–µ—Ä–Ω–∏:</strong> ${correct} / ${t} (${pct}%)</p>
    <p>‚ùå <strong>–ì—Ä–µ—à–Ω–∏:</strong> ${wrong.length > 0 ? wrong.join(", ") : "‚Äî"}</p>
    <p>‚ö†Ô∏è <strong>–í–µ—Ä–Ω–∏, –Ω–æ –Ω–µ—Å–∏–≥—É—Ä–Ω–∏:</strong> ${correctButNotSure.length > 0 ? correctButNotSure.join(", ") : "‚Äî"}</p>
    <p>‚ùì <strong>–ù–µ –∑–Ω–∞–º:</strong> ${dk.length > 0 ? dk.join(", ") : "‚Äî"}</p>
    <p>‚è± <strong>–í—Ä–µ–º–µ:</strong> ${Math.floor(sec / 60)}m ${sec % 60}s (—Å—Ä–µ–¥–Ω–æ ${t ? Math.round(sec / t) : 0}s/–≤—ä–ø—Ä–æ—Å)</p>
    ${reviewHtml}`;

  if (currentMode === "learning") {
    $("reviewWrongBtn")?.addEventListener("click", () => startRound("reviewWrong", computeStats(baseState, baseStack).wrong));
    $("reviewNotSureBtn")?.addEventListener("click", () => startRound("reviewNotSure", computeStats(baseState, baseStack).ns));
    $("reviewDontKnowBtn")?.addEventListener("click", () => startRound("reviewDontKnow", computeStats(baseState, baseStack).dk));
    $("backToBaseResultsBtn")?.addEventListener("click", () => { 
      currentRoundType = "base"; 
      questionState = deepClone(baseState); 
      STACK = baseStack.slice(); 
      examStartTime = null; 
      renderStatsScreen(); 
    });
  }
}
</script>
</body>
</html>
