<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Agentforce Exam</title>
<style>
  * { box-sizing: border-box; }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    max-width: 900px;
    margin: 0 auto;
    padding: 12px;
    font-size: 16px;
    line-height: 1.5;
    background: #fff;
  }

  h2 { font-size: 1.4rem; margin: 0 0 12px 0; }

  button {
    padding: 12px 16px;
    font-size: 16px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f5f5f5;
    cursor: pointer;
    touch-action: manipulation;
  }

  button:active { background: #e0e0e0; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  .hidden { display: none; }

  /* Setup Panel */
  #setupPanel {
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 16px;
    background: #fafafa;
  }

  .setup-step {
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid #eee;
  }

  .setup-step:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }

  .step-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }

  .step-number {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #ddd;
    color: #666;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
  }

  .step-number.done { background: #28a745; color: #fff; }
  .step-number.active { background: #007bff; color: #fff; }

  .step-title { font-weight: 600; font-size: 15px; color: #333; }

  .mode-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
  .mode-buttons button { flex: 1; min-width: 140px; padding: 14px 16px; }
  .mode-buttons button.selected { background: #007bff; color: #fff; border-color: #007bff; }

  .mode-desc { font-size: 13px; color: #666; margin-top: 8px; }

  #examButtons { display: flex; flex-wrap: wrap; gap: 8px; }
  #examButtons button { flex: 1; min-width: calc(50% - 4px); }

  #startBtn { 
    width: 100%; 
    padding: 16px; 
    font-size: 18px; 
    font-weight: 600;
    background: #28a745; 
    color: #fff; 
    border-color: #28a745; 
  }
  #startBtn:active { background: #1e7e34; }

  /* Timer & Help */
  #timer {
    color: #555;
    font-size: 15px;
    font-weight: 600;
    padding: 8px 12px;
    background: #f0f0f0;
    border-radius: 6px;
    display: inline-block;
    margin-bottom: 10px;
  }

  #helpToggle { color: #666; font-size: 14px; cursor: pointer; padding: 8px 0; display: inline-block; }

  #helpBox {
    border: 1px solid #e0e0e0;
    padding: 12px;
    font-size: 14px;
    color: #555;
    margin-bottom: 12px;
    background: #fafafa;
    border-radius: 8px;
  }

  #helpBox > div { display: flex; flex-direction: column; gap: 6px; }

  /* Exam UI */
  .question-header { display: flex; flex-direction: column; gap: 10px; margin-bottom: 12px; }
  #counter { font-weight: 600; font-size: 15px; color: #333; margin: 0; }
  
  #modeIndicator { 
    font-size: 12px; 
    padding: 4px 8px; 
    border-radius: 4px; 
    display: inline-block;
    margin-top: 4px;
  }
  #modeIndicator.learning { background: #d4edda; color: #155724; }
  #modeIndicator.exam { background: #fff3cd; color: #856404; }

  .confidence-panel {
    border: 1px solid #e0e0e0;
    background: #fafafa;
    padding: 12px;
    font-size: 15px;
    border-radius: 8px;
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }

  .confidence-panel label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
  .confidence-panel input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }

  .question-box {
    border: 1px solid #e0e0e0;
    background: #f7f7f7;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 12px;
  }

  .question-box p { margin: 0; font-size: 16px; line-height: 1.6; }

  .answers-box {
    border: 1px solid #e0e0e0;
    background: #fafafa;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 12px;
  }

  .answer {
    padding: 14px 12px;
    margin-bottom: 8px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    transition: background 0.15s;
  }

  .answer:last-child { margin-bottom: 0; }
  .answer:active { background: #f0f0f0; }
  .answer span { color: #888; font-size: 13px; font-weight: 600; min-width: 24px; }

  .answer label {
    flex: 1;
    font-size: 15px;
    line-height: 1.5;
    cursor: pointer;
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }

  .answer input[type="radio"] { width: 22px; height: 22px; min-width: 22px; cursor: pointer; margin: 0; }

  .answer.correct { background: #d4edda; border-color: #28a745; }
  .answer.correct label { color: #155724; font-weight: 600; }
  .answer.wrong { background: #f8d7da; border-color: #dc3545; }
  .answer.wrong label { color: #721c24; font-weight: 600; }

  #resultLine {
    margin-top: 12px;
    padding: 12px;
    font-weight: 600;
    font-size: 15px;
    border-radius: 6px;
    text-align: center;
  }

  #resultLine:empty { display: none; }

  .nav-buttons { display: flex; gap: 10px; margin-top: 12px; }
  .nav-buttons button { flex: 1; padding: 14px; font-size: 16px; font-weight: 600; }
  #nextBtn { background: #007bff; color: #fff; border-color: #007bff; }
  #nextBtn:active { background: #0056b3; }

  #stats { padding: 16px; background: #f9f9f9; border-radius: 10px; margin-top: 12px; }
  #stats h3 { margin: 0 0 12px 0; font-size: 1.2rem; }
  #stats p { margin: 8px 0; font-size: 15px; line-height: 1.5; word-break: break-word; }

  #reviewButtons { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }
  #reviewButtons button { width: 100%; text-align: left; padding: 14px 16px; }

  @media (min-width: 600px) {
    body { padding: 20px; }
    .question-header { flex-direction: row; justify-content: space-between; align-items: center; }
    #examButtons button { min-width: auto; flex: none; }
    #reviewButtons { flex-direction: row; flex-wrap: wrap; }
    #reviewButtons button { width: auto; flex: 1; }
  }
</style>
</head>
<body>

<h2>Agentforce Exam</h2>

<!-- SETUP PANEL -->
<div id="setupPanel">
  
  <!-- Step 1: Load -->
  <div class="setup-step">
    <div class="step-header">
      <div class="step-number" id="step1num">1</div>
      <div class="step-title">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –≤—ä–ø—Ä–æ—Å–∏</div>
      <span id="loadStatus" style="margin-left:auto;">‚è≥ –ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</span>
    </div>
  </div>

  <!-- Step 2: Mode -->
  <div class="setup-step">
    <div class="step-header">
      <div class="step-number" id="step2num">2</div>
      <div class="step-title">–ò–∑–±–µ—Ä–∏ —Ä–µ–∂–∏–º</div>
    </div>
    <div class="mode-buttons">
      <button id="learningModeBtn" disabled>üìö Learning</button>
      <button id="examModeBtn" disabled>üìù Exam</button>
    </div>
    <div class="mode-desc" id="modeDesc">–ü—ä—Ä–≤–æ –∏–∑—á–∞–∫–∞–π –≤—ä–ø—Ä–æ—Å–∏—Ç–µ –¥–∞ —Å–µ –∑–∞—Ä–µ–¥—è—Ç.</div>
  </div>

  <!-- Step 3: Exam -->
  <div class="setup-step">
    <div class="step-header">
      <div class="step-number" id="step3num">3</div>
      <div class="step-title">–ò–∑–±–µ—Ä–∏ –∏–∑–ø–∏—Ç</div>
      <button id="reshuffleBtn" class="hidden" style="margin-left:auto;padding:8px 12px;font-size:14px;">üîÄ –†–∞–∑–±—ä—Ä–∫–∞–π –ø–∞–∫</button>
    </div>
    <div id="examButtons"></div>
    <div id="examPlaceholder" style="color:#999;font-size:14px;">–ü—ä—Ä–≤–æ –∏–∑–±–µ—Ä–∏ —Ä–µ–∂–∏–º.</div>
  </div>

  <!-- Step 4: Start -->
  <div class="setup-step">
    <button id="startBtn" disabled>‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
  </div>

</div>

<!-- EXAM UI -->
<div id="examUI" class="hidden">
  <div id="timer">Time: 105:00</div>
  
  <button id="exitBtn" style="margin-bottom:10px;">‚úï –°–º–µ–Ω–∏ –∏–∑–ø–∏—Ç</button>
  <span id="helpToggle">üõà –ü–æ–º–æ—â</span>
  <div id="helpBox" class="hidden">
    <div>
      <div>üî¢ <b>1‚Äì4</b> ‚Äì –∏–∑–±–æ—Ä –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä</div>
      <div>‚û°Ô∏è <b>‚Üí / Enter</b> ‚Äì Next</div>
      <div>‚¨ÖÔ∏è <b>‚Üê</b> ‚Äì Back</div>
    </div>
  </div>

  <div class="question-header">
    <div>
      <p id="counter"></p>
      <span id="modeIndicator"></span>
    </div>
    <div class="confidence-panel">
      <label><input type="checkbox" id="dontKnow"> ‚ùì –ù–µ –∑–Ω–∞–º</label>
      <label><input type="checkbox" id="notSure"> ‚ö†Ô∏è –ù–µ —Å—ä–º —Å–∏–≥—É—Ä–µ–Ω</label>
    </div>
  </div>

  <div class="question-box"><p id="question"></p></div>

  <div class="answers-box">
    <div id="answers"></div>
    <div id="resultLine"></div>
  </div>

  <div class="nav-buttons">
    <button id="backBtn">‚Üê Back</button>
    <button id="nextBtn">Next ‚Üí</button>
  </div>
</div>

<div id="stats" class="hidden"></div>

<script>
const $ = id => document.getElementById(id);

// DOM refs
const setupPanel = $("setupPanel");
const examUI = $("examUI");
const timerEl = $("timer");
const statsEl = $("stats");
const helpBoxEl = $("helpBox");
const helpToggleEl = $("helpToggle");
const counterEl = $("counter");
const modeIndicatorEl = $("modeIndicator");
const questionEl = $("question");
const answersEl = $("answers");
const dontKnowEl = $("dontKnow");
const notSureEl = $("notSure");
const resultLineEl = $("resultLine");
const backBtn = $("backBtn");
const nextBtn = $("nextBtn");
const loadStatusEl = $("loadStatus");
const learningModeBtn = $("learningModeBtn");
const examModeBtn = $("examModeBtn");
const modeDescEl = $("modeDesc");
const examButtonsEl = $("examButtons");
const examPlaceholder = $("examPlaceholder");
const startBtn = $("startBtn");
const step1num = $("step1num");
const step2num = $("step2num");
const step3num = $("step3num");

// State
let QUESTIONS = {}, ALL_QIDS = [], EXAMS = [], STACK = [], index = 0;
let questionState = {}, answerOrder = {};
let baseStack = null, baseState = null;
let examStartTime = null, timerInterval = null;
const EXAM_TIME_SECONDS = 105 * 60;
let currentRoundType = "base";
let currentMode = null; // "learning" or "exam"
let selectedExamIndex = null;

// Load questions
fetch("./agentforce_questions.json")
  .then(r => { if (!r.ok) throw new Error("JSON load failed"); return r.json(); })
  .then(d => {
    d.questions.forEach(q => { QUESTIONS[q.number] = q; ALL_QIDS.push(q.number); });
    loadStatusEl.textContent = `‚úÖ –ó–∞—Ä–µ–¥–µ–Ω–∏ ${ALL_QIDS.length} –≤—ä–ø—Ä–æ—Å–∞`;
    loadStatusEl.style.color = "#28a745";
    step1num.classList.add("done");
    step2num.classList.add("active");
    learningModeBtn.disabled = false;
    examModeBtn.disabled = false;
    modeDescEl.textContent = "–ò–∑–±–µ—Ä–∏ –∫–∞–∫ –∏—Å–∫–∞—à –¥–∞ —Å–µ —É–ø—Ä–∞–∂–Ω—è–≤–∞—à.";
  })
  .catch(err => {
    loadStatusEl.textContent = "‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ";
    loadStatusEl.style.color = "#dc3545";
    console.error(err);
  });

// Helpers
function shuffle(arr) { return arr.map(v => ({ v, r: Math.random() })).sort((a, b) => a.r - b.r).map(x => x.v); }
function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }
function getCorrectText(qid) { return QUESTIONS[qid].correct.map(a => QUESTIONS[qid].answers[a]).join(", "); }
function ensureOrderForQid(qid) { if (!answerOrder[qid]) answerOrder[qid] = shuffle(Object.entries(QUESTIONS[qid].answers)); }

const reshuffleBtn = $("reshuffleBtn");

// Step 2: Mode selection
function selectMode(mode) {
  currentMode = mode;
  learningModeBtn.classList.toggle("selected", mode === "learning");
  examModeBtn.classList.toggle("selected", mode === "exam");
  
  if (mode === "learning") {
    modeDescEl.textContent = "üìö –í–∏–∂–¥–∞—à –≤–µ—Ä–Ω–∏—è –æ—Ç–≥–æ–≤–æ—Ä –≤–µ–¥–Ω–∞–≥–∞. –ú–æ–∂–µ—à –¥–∞ –ø—Ä–µ–≥–æ–≤–∞—Ä—è—à –≥—Ä–µ—à–∫–∏—Ç–µ.";
  } else {
    modeDescEl.textContent = "üìù –°–∏–º—É–ª–∞—Ü–∏—è –Ω–∞ –∏–∑–ø–∏—Ç. –†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —Å–µ –ø–æ–∫–∞–∑–≤–∞—Ç –Ω–∞–∫—Ä–∞—è.";
  }
  
  step2num.classList.remove("active");
  step2num.classList.add("done");
  step3num.classList.add("active");
  
  generateExams();
}

learningModeBtn.addEventListener("click", () => selectMode("learning"));
examModeBtn.addEventListener("click", () => selectMode("exam"));

// Step 3: Generate exams
function generateExams() {
  const s = shuffle([...ALL_QIDS]);
  EXAMS = [];
  const size = Math.ceil(s.length / 5);
  for (let i = 0; i < 5; i++) EXAMS.push(s.slice(i * size, (i + 1) * size));
  
  examPlaceholder.classList.add("hidden");
  reshuffleBtn.classList.remove("hidden");
  selectedExamIndex = null;
  startBtn.disabled = true;
  
  examButtonsEl.innerHTML = EXAMS.map((e, i) => 
    `<button data-exam="${i}">–ò–∑–ø–∏—Ç ${i + 1} (${e.length} –≤—ä–ø—Ä.)</button>`
  ).join("");
}

reshuffleBtn.addEventListener("click", () => {
  generateExams();
  step3num.classList.remove("done");
  step3num.classList.add("active");
});

examButtonsEl.addEventListener("click", e => {
  const btn = e.target.closest("button");
  if (!btn) return;
  
  // Deselect all, select clicked
  examButtonsEl.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
  btn.classList.add("selected");
  
  selectedExamIndex = Number(btn.dataset.exam);
  step3num.classList.remove("active");
  step3num.classList.add("done");
  startBtn.disabled = false;
});

// Step 4: Start
startBtn.addEventListener("click", () => {
  if (selectedExamIndex === null || !currentMode) return;
  startRound("base", EXAMS[selectedExamIndex]);
});

const exitBtn = $("exitBtn");

// Exit to setup
exitBtn.addEventListener("click", () => {
  if (!confirm("–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏? –ü—Ä–æ–≥—Ä–µ—Å—ä—Ç —â–µ –±—ä–¥–µ –∑–∞–≥—É–±–µ–Ω.")) return;
  clearInterval(timerInterval);
  examUI.classList.add("hidden");
  setupPanel.classList.remove("hidden");
  // Reset for new exam selection
  selectedExamIndex = null;
  examButtonsEl.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
  step3num.classList.remove("done");
  step3num.classList.add("active");
  startBtn.disabled = true;
});

// Timer
function startTimer() {
  clearInterval(timerInterval);
  examStartTime = Date.now();
  timerEl.innerText = "Time: 105:00";
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - examStartTime) / 1000);
    const remaining = Math.max(EXAM_TIME_SECONDS - elapsed, 0);
    timerEl.innerText = `Time: ${String(Math.floor(remaining / 60)).padStart(2, "0")}:${String(remaining % 60).padStart(2, "0")}`;
    if (remaining === 0) finishExam();
  }, 1000);
}

function startRound(roundType, stack) {
  if (!stack || !stack.length) return;
  currentRoundType = roundType;
  STACK = stack.slice();
  index = 0;
  questionState = {};
  answerOrder = {};
  
  setupPanel.classList.add("hidden");
  statsEl.classList.add("hidden");
  examUI.classList.remove("hidden");
  
  modeIndicatorEl.textContent = currentMode === "learning" ? "üìö Learning" : "üìù Exam";
  modeIndicatorEl.className = currentMode;
  
  startTimer();
  showQuestion();
}

function showQuestion() {
  const qid = STACK[index], q = QUESTIONS[qid];
  ensureOrderForQid(qid);
  const state = questionState[qid];

  counterEl.innerText = `[Q${qid}] ${index + 1} / ${STACK.length}`;
  questionEl.innerText = q.question;
  answersEl.innerHTML = "";
  resultLineEl.innerHTML = "";
  resultLineEl.style.background = "";
  resultLineEl.style.color = "";

  dontKnowEl.checked = state?.dontKnow || false;
  notSureEl.checked = state?.notSure || false;

  answerOrder[qid].forEach(([l, t], i) => {
    answersEl.innerHTML += `<div class="answer" data-letter="${l}"><span>(${i + 1})</span><label><input type="radio" name="answer" value="${l}">${t}</label></div>`;
  });

  if (state?.selectedAnswer) {
    const r = document.querySelector(`input[name="answer"][value="${state.selectedAnswer}"]`);
    if (r) r.checked = true;
  }

  // Learning mode: show feedback if already answered
  if (currentMode === "learning" && state && state.status && state.status !== "unanswered") {
    document.querySelectorAll('input[name="answer"]').forEach(r => r.disabled = true);
    dontKnowEl.disabled = true;
    notSureEl.disabled = true;
    const selWrap = document.querySelector(`input[name="answer"][value="${state.selectedAnswer}"]`)?.closest(".answer");
    if (state.status === "correct") {
      selWrap?.classList.add("correct");
      resultLineEl.innerText = "‚úÖ –í—è—Ä–Ω–æ";
      resultLineEl.style.background = "#d4edda";
      resultLineEl.style.color = "#155724";
    } else {
      selWrap?.classList.add("wrong");
      resultLineEl.innerText = `‚ùå –ì—Ä–µ—à–Ω–æ ‚Üí ${getCorrectText(qid)}`;
      resultLineEl.style.background = "#f8d7da";
      resultLineEl.style.color = "#721c24";
    }
  } else {
    document.querySelectorAll('input[name="answer"]').forEach(r => r.disabled = false);
    dontKnowEl.disabled = false;
    notSureEl.disabled = false;
  }
}

function upsertDraftState() {
  const qid = STACK[index], existing = questionState[qid];
  if (currentMode === "learning" && existing && existing.status && existing.status !== "unanswered") return;
  const sel = document.querySelector('input[name="answer"]:checked');
  questionState[qid] = {
    selectedAnswer: sel ? sel.value : (existing?.selectedAnswer || null),
    status: existing?.status || "unanswered",
    dontKnow: dontKnowEl.checked,
    notSure: notSureEl.checked
  };
}

answersEl.addEventListener("change", e => { if (e.target?.name === "answer") upsertDraftState(); });
answersEl.addEventListener("click", e => {
  const answerDiv = e.target.closest(".answer");
  if (answerDiv) {
    const radio = answerDiv.querySelector('input[type="radio"]');
    if (radio && !radio.disabled) { radio.checked = true; upsertDraftState(); }
  }
});
dontKnowEl.addEventListener("change", upsertDraftState);
notSureEl.addEventListener("change", upsertDraftState);

function checkCurrentQuestion() {
  const qid = STACK[index], q = QUESTIONS[qid];
  const sel = document.querySelector('input[name="answer"]:checked');
  if (!sel) return false;
  questionState[qid] = {
    selectedAnswer: sel.value,
    status: q.correct.includes(sel.value) ? "correct" : "wrong",
    dontKnow: dontKnowEl.checked,
    notSure: notSureEl.checked
  };
  return true;
}

function nextAction() {
  const qid = STACK[index];
  const state = questionState[qid];
  const sel = document.querySelector('input[name="answer"]:checked');
  
  if (!sel) return;

  if (currentMode === "learning") {
    if (!state || state.status === "unanswered") {
      checkCurrentQuestion();
      showQuestion();
      return;
    }
    if (index < STACK.length - 1) { index++; showQuestion(); }
    else finishExam();
  } else {
    checkCurrentQuestion();
    if (index < STACK.length - 1) { index++; showQuestion(); }
    else finishExam();
  }
}

function goBack() { if (index > 0) { index--; showQuestion(); } }

nextBtn.addEventListener("click", nextAction);
backBtn.addEventListener("click", goBack);

document.addEventListener("keydown", e => {
  if (examUI.classList.contains("hidden")) return;
  if (["1", "2", "3", "4"].includes(e.key)) {
    const radios = document.querySelectorAll('input[name="answer"]');
    if (radios[e.key - 1] && !radios[e.key - 1].disabled) { radios[e.key - 1].checked = true; upsertDraftState(); }
  }
  if (e.key === "ArrowRight" || e.key === "Enter") nextAction();
  if (e.key === "ArrowLeft") goBack();
});

helpToggleEl.addEventListener("click", () => helpBoxEl.classList.toggle("hidden"));

function computeStats(stateObj, stackArr) {
  let correct = 0, wrong = [], dk = [], ns = [], correctButNotSure = [];
  stackArr.forEach(qid => {
    const s = stateObj[qid];
    if (!s || !s.status || s.status === "unanswered") return;
    if (s.dontKnow) dk.push(qid);
    if (s.notSure) ns.push(qid);
    if (s.status === "correct") { correct++; if (s.notSure) correctButNotSure.push(qid); }
    else wrong.push(qid);
  });
  return { correct, wrong, dk, ns, correctButNotSure };
}

function finishExam() {
  clearInterval(timerInterval);
  examUI.classList.add("hidden");
  if (currentRoundType === "base") { baseState = deepClone(questionState); baseStack = STACK.slice(); }
  renderStatsScreen();
}

function renderStatsScreen() {
  statsEl.classList.remove("hidden");
  const t = STACK.length, sec = examStartTime ? Math.floor((Date.Now() - examStartTime) / 1000) : 0;
  const { correct, wrong, dk, ns, correctButNotSure } = computeStats(questionState, STACK);
  const pct = t ? Math.round(correct / t * 100) : 0;
  const passed = pct >= 72;
  
  const modeLabel = currentMode === "learning" ? "üìö Learning" : "üìù Exam";
  const titles = { base: "–†–µ–∑—É–ª—Ç–∞—Ç", reviewWrong: "–ü—Ä–µ–≥–ª–µ–¥: –≥—Ä–µ—à–Ω–∏", reviewNotSure: "–ü—Ä–µ–≥–ª–µ–¥: –Ω–µ—Å–∏–≥—É—Ä–Ω–∏", reviewDontKnow: "–ü—Ä–µ–≥–ª–µ–¥: –Ω–µ –∑–Ω–∞–º" };

  let reviewHtml = "";
  if (baseState && baseStack && currentMode === "learning") {
    const bs = computeStats(baseState, baseStack);
    reviewHtml = `<div id="reviewButtons">
      <button id="reviewWrongBtn" ${bs.wrong.length ? "" : "disabled"}>üîÅ –ì—Ä–µ—à–Ω–∏ (${bs.wrong.length})</button>
      <button id="reviewNotSureBtn" ${bs.ns.length ? "" : "disabled"}>‚ö†Ô∏è –ù–µ—Å–∏–≥—É—Ä–Ω–∏ (${bs.ns.length})</button>
      <button id="reviewDontKnowBtn" ${bs.dk.length ? "" : "disabled"}>‚ùì –ù–µ –∑–Ω–∞–º (${bs.dk.length})</button>
      ${currentRoundType !== "base" ? `<button id="backToBaseResultsBtn">‚¨ÖÔ∏è –û—Å–Ω–æ–≤–µ–Ω —Ä–µ–∑—É–ª—Ç–∞—Ç</button>` : ""}
    </div>`;
  }

  let newExamHtml = `<div style="margin-top:16px;"><button id="newExamBtn">üîÑ –ù–æ–≤ –∏–∑–ø–∏—Ç</button></div>`;

  statsEl.innerHTML = `
    <h3>${titles[currentRoundType] || "–†–µ–∑—É–ª—Ç–∞—Ç"} <small style="font-weight:normal;color:#666;">(${modeLabel})</small></h3>
    <p style="font-size:18px;"><strong>${passed ? "‚úÖ –í–ó–ï–¢" : "‚ùå –ù–ï –ï –í–ó–ï–¢"}</strong> (–º–∏–Ω. 72%)</p>
    <p><strong>–í–µ—Ä–Ω–∏:</strong> ${correct} / ${t} (${pct}%)</p>
    <p>‚ùå <strong>–ì—Ä–µ—à–Ω–∏:</strong> ${wrong.length > 0 ? wrong.join(", ") : "‚Äî"}</p>
    <p>‚ö†Ô∏è <strong>–í–µ—Ä–Ω–∏, –Ω–æ –Ω–µ—Å–∏–≥—É—Ä–Ω–∏:</strong> ${correctButNotSure.length > 0 ? correctButNotSure.join(", ") : "‚Äî"}</p>
    <p>‚ùì <strong>–ù–µ –∑–Ω–∞–º:</strong> ${dk.length > 0 ? dk.join(", ") : "‚Äî"}</p>
    <p>‚è± <strong>–í—Ä–µ–º–µ:</strong> ${Math.floor(sec / 60)}m ${sec % 60}s (—Å—Ä–µ–¥–Ω–æ ${t ? Math.round(sec / t) : 0}s/–≤—ä–ø—Ä–æ—Å)</p>
    ${reviewHtml}
    ${newExamHtml}`;

  $("newExamBtn")?.addEventListener("click", () => {
    statsEl.classList.add("hidden");
    setupPanel.classList.remove("hidden");
    // Reset steps 2 & 3
    currentMode = null;
    selectedExamIndex = null;
    learningModeBtn.classList.remove("selected");
    examModeBtn.classList.remove("selected");
    step2num.classList.remove("done");
    step2num.classList.add("active");
    step3num.classList.remove("done", "active");
    examButtonsEl.innerHTML = "";
    examPlaceholder.classList.remove("hidden");
    examPlaceholder.textContent = "–ü—ä—Ä–≤–æ –∏–∑–±–µ—Ä–∏ —Ä–µ–∂–∏–º.";
    startBtn.disabled = true;
    modeDescEl.textContent = "–ò–∑–±–µ—Ä–∏ –∫–∞–∫ –∏—Å–∫–∞—à –¥–∞ —Å–µ —É–ø—Ä–∞–∂–Ω—è–≤–∞—à.";
  });

  if (currentMode === "learning") {
    $("reviewWrongBtn")?.addEventListener("click", () => { statsEl.classList.add("hidden"); startRound("reviewWrong", computeStats(baseState, baseStack).wrong); });
    $("reviewNotSureBtn")?.addEventListener("click", () => { statsEl.classList.add("hidden"); startRound("reviewNotSure", computeStats(baseState, baseStack).ns); });
    $("reviewDontKnowBtn")?.addEventListener("click", () => { statsEl.classList.add("hidden"); startRound("reviewDontKnow", computeStats(baseState, baseStack).dk); });
    $("backToBaseResultsBtn")?.addEventListener("click", () => { 
      currentRoundType = "base"; 
      questionState = deepClone(baseState); 
      STACK = baseStack.slice(); 
      examStartTime = null; 
      renderStatsScreen(); 
    });
  }
}
</script>
</body>
</html>
